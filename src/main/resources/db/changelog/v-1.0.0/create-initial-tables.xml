<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
                   xmlns:pro="http://www.liquibase.org/xml/ns/pro" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext
                   https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd
                   http://www.liquibase.org/xml/ns/pro
                   https://www.liquibase.org/xml/ns/pro/liquibase-pro-4.6.xsd
                   http://www.liquibase.org/xml/ns/dbchangelog
                   https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.6.xsd">

    <changeSet author="Bisha" id="create_categories_id_seq">
        <preConditions onFail="MARK_RAN">
            <not>
                <sequenceExists sequenceName="categories_id_seq"/>
            </not>
        </preConditions>
        <comment>Create categories id seq</comment>
        <createSequence cacheSize="1" cycle="false" dataType="bigint" incrementBy="1" maxValue="9223372036854775807"
                        minValue="1" sequenceName="categories_id_seq" startValue="1"/>
    </changeSet>

    <changeSet author="Bisha" id="create_category_table">
        <preConditions onFail="MARK_RAN">
            <and>
                <not>
                    <tableExists tableName="category"/>
                </not>
                <not>
                    <tableExists tableName="categories"/>
                </not>
            </and>
        </preConditions>
        <comment>Create table category</comment>
        <createTable tableName="category">
            <column autoIncrement="true" name="id" type="INTEGER">
                <constraints nullable="false" primaryKey="true" primaryKeyName="category_pkey"/>
            </column>
            <column name="name" type="VARCHAR(255)"/>
        </createTable>
    </changeSet>


    <changeSet author="Bisha" id="create_clients_id_seq">
        <preConditions onFail="MARK_RAN">
            <not>
                <sequenceExists sequenceName="clients_id_seq"/>
            </not>
        </preConditions>
        <comment>Create clients id seq</comment>
        <createSequence cacheSize="1" cycle="false" dataType="bigint" incrementBy="1" maxValue="9223372036854775807"
                        minValue="1" sequenceName="clients_id_seq" startValue="1"/>
    </changeSet>

    <changeSet author="Bisha" id="create_clients_table">
        <preConditions onFail="MARK_RAN">
            <and>
                <not>
                    <tableExists tableName="clientstable"/>
                </not>
                <not>
                    <tableExists tableName="clients"/>
                </not>
            </and>
        </preConditions>
        <comment>Create clients table</comment>
        <createTable tableName="clientstable">
            <column autoIncrement="true" name="id" type="INTEGER">
                <constraints nullable="false" primaryKey="true" primaryKeyName="clientstable_pkey"/>
            </column>
            <column name="name" type="VARCHAR(355)"/>
            <column name="phone_number" type="VARCHAR(20)"/>
            <column name="phone_number2" type="VARCHAR(20)"/>
            <column name="phone_number3" type="VARCHAR(20)"/>
            <column name="address" type="VARCHAR(355)"/>
            <column name="discount" type="INTEGER"/>
            <column name="vk_id" type="VARCHAR(355)"/>
            <column name="fb_id" type="VARCHAR(355)"/>
            <column name="instagram_id" type="VARCHAR(32)"/>
            <column name="mailing_approval" type="BOOLEAN"/>
            <column defaultValueComputed="now()" name="timestamp" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="notes" type="VARCHAR(255)"/>
        </createTable>
    </changeSet>


    <changeSet author="Bisha" id="create_comment_id_seq">
        <preConditions onFail="MARK_RAN">
            <not>
                <sequenceExists sequenceName="comment_id_seq"/>
            </not>
        </preConditions>
        <comment>Create comment id seq</comment>
        <createSequence cacheSize="1" cycle="false" dataType="bigint" incrementBy="1" maxValue="9223372036854775807"
                        minValue="1" sequenceName="comment_id_seq" startValue="1"/>
    </changeSet>

    <changeSet author="Bisha" id="create_comment_table">
        <preConditions onFail="MARK_RAN">
            <and>
                <not>
                    <tableExists tableName="commenttable"/>
                </not>
                <not>
                    <tableExists tableName="comments"/>
                </not>
            </and>
        </preConditions>
        <comment>Create comment table</comment>
        <createTable tableName="commenttable">
            <column autoIncrement="true" name="comment_id" type="INTEGER">
                <constraints nullable="false" primaryKey="true" primaryKeyName="commenttable_pkey"/>
            </column>
            <column defaultValueComputed="now()" name="timestamp" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="autor_id" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="order_id" type="INTEGER"/>
            <column name="client_id" type="INTEGER"/>
            <column name="bike_id" type="INTEGER"/>
            <column name="text" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="coomment_type" type="INTEGER">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>


    <changeSet author="Bisha" id="create_devices_id_seq">
        <preConditions onFail="MARK_RAN">
            <not>
                <sequenceExists sequenceName="devises_id_seq"/>
            </not>
        </preConditions>
        <comment>Create devices_id_seq</comment>
        <createSequence cacheSize="1" cycle="false" dataType="bigint" incrementBy="1" maxValue="9223372036854775807"
                        minValue="1" sequenceName="devices_id_seq" startValue="1"/>
    </changeSet>


    <changeSet author="Bisha" id="create_devicestable">
        <preConditions onFail="MARK_RAN">
            <and>
                <not>
                    <tableExists tableName="devicestable"/>
                </not>
                <not>
                    <tableExists tableName="devices"/>
                </not>
            </and>
        </preConditions>
        <comment>Create devicestable</comment>
        <createTable tableName="devicestable">
            <column autoIncrement="true" name="device_id" type="INTEGER">
                <constraints nullable="false" primaryKey="true" primaryKeyName="devicestable_pkey"/>
            </column>
            <column name="vendor" type="VARCHAR(100)"/>
            <column name="model" type="VARCHAR(100)"/>
            <column name="owner" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="serial_number" type="INTEGER"/>
            <column name="description" type="TEXT"/>
            <column name="device_type" type="INTEGER"/>
            <column defaultValueComputed="now()" name="timestamp" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="device_name" type="VARCHAR(100)"/>
        </createTable>
    </changeSet>


    <changeSet author="Bisha" id="create_item_id_seq">
        <preConditions onFail="MARK_RAN">
            <not>
                <sequenceExists sequenceName="item_id_seq"/>
            </not>
        </preConditions>
        <comment>Create item_id_seq</comment>
        <createSequence cacheSize="1" cycle="false" dataType="bigint" incrementBy="1" maxValue="9223372036854775807"
                        minValue="1" sequenceName="item_id_seq" startValue="1"/>
    </changeSet>

    <changeSet author="Bisha" id="create_item_table">
        <preConditions onFail="MARK_RAN">
            <and>
                <not>
                    <tableExists tableName="item"/>
                </not>
                <not>
                    <tableExists tableName="items"/>
                </not>
            </and>
        </preConditions>
        <comment>Create item table</comment>
        <createTable tableName="item">
            <column autoIncrement="true" name="id" type="INTEGER">
                <constraints nullable="false" primaryKey="true" primaryKeyName="item_pkey"/>
            </column>
            <column name="name" type="VARCHAR(255)"/>
            <column name="description" type="VARCHAR(255)"/>
            <column name="price" type="numeric(9, 2)"/>
            <column name="category_id" type="INTEGER"/>
            <column name="priority" type="INTEGER"/>
        </createTable>
    </changeSet>


    <changeSet author="Bisha" id="create_status_id_seq">
        <preConditions onFail="MARK_RAN">
            <not>
                <sequenceExists sequenceName="status_id_seq"/>
            </not>
        </preConditions>
        <comment>Create status_id_seq</comment>
        <createSequence cacheSize="1" cycle="false" dataType="bigint" incrementBy="1" maxValue="9223372036854775807"
                        minValue="1" sequenceName="status_id_seq" startValue="1"/>
    </changeSet>

    <changeSet author="Bisha" id="create_status_table">
        <preConditions onFail="MARK_RAN">
            <and>
                <not>
                    <tableExists tableName="status"/>
                </not>
                <not>
                    <tableExists tableName="statuses"/>
                </not>
            </and>
        </preConditions>
        <comment>Create status table</comment>
        <createTable tableName="status">
            <column autoIncrement="true" name="statusid" type="INTEGER">
                <constraints nullable="false" primaryKey="true" primaryKeyName="status_pkey"/>
            </column>
            <column name="name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="colour" type="VARCHAR(50)"/>
            <column name="hide" type="BOOLEAN"/>
        </createTable>
    </changeSet>


    <changeSet author="Bisha" id="create_orders_id_seq">
        <preConditions onFail="MARK_RAN">
            <not>
                <sequenceExists sequenceName="orders_id_seq"/>
            </not>
        </preConditions>
        <comment>Create orders_id_seq</comment>
        <createSequence cacheSize="1" cycle="false" dataType="bigint" incrementBy="1" maxValue="9223372036854775807"
                        minValue="1" sequenceName="orders_id_seq" startValue="1"/>
    </changeSet>

    <changeSet author="Bisha" id="create_orderstable">
        <preConditions onFail="MARK_RAN">
            <and>
                <not>
                    <tableExists tableName="orderstable"/>
                </not>
                <not>
                    <tableExists tableName="orders"/>
                </not>
            </and>
        </preConditions>
        <comment>Create orders table</comment>
        <createTable tableName="orderstable">
            <column autoIncrement="true" name="order_id" type="INTEGER">
                <constraints nullable="false" primaryKey="true" primaryKeyName="orderstable_pkey"/>
            </column>
            <column defaultValueComputed="now()" name="timestamp" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="client_id" type="INTEGER"/>
            <column name="small_description" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="full_description" type="TEXT"/>
            <column defaultValueNumeric="1" name="execute_status" type="INTEGER"/>
            <column name="executor_id" type="INTEGER"/>
            <column name="parts_price" type="numeric(9, 2)"/>
            <column name="work_price" type="numeric(9, 2)"/>
            <column name="parts" type="TEXT"/>
            <column name="works" type="TEXT"/>
            <column name="payment_status" type="INTEGER"/>
            <column name="bike_id" type="INTEGER"/>
            <column name="order_description" type="TEXT"/>
            <column name="time_close" type="date"/>
            <column name="full_price" type="numeric(9, 2)"/>
        </createTable>
    </changeSet>


    <changeSet author="Bisha" id="create_stock_id_seq">
        <preConditions onFail="MARK_RAN">
            <not>
                <sequenceExists sequenceName="stock_id_seq"/>
            </not>
        </preConditions>
        <comment>Create stock_id_seq</comment>
        <createSequence cacheSize="1" cycle="false" dataType="bigint" incrementBy="1" maxValue="9223372036854775807"
                        minValue="1" sequenceName="stock_id_seq" startValue="1"/>
    </changeSet>

    <changeSet author="Bisha" id="create_stock_table">
        <preConditions onFail="MARK_RAN">
            <and>
                <not>
                    <tableExists tableName="stock"/>
                </not>
                <not>
                    <tableExists tableName="stocks"/>
                </not>
            </and>
        </preConditions>
        <comment>Create stock table</comment>
        <createTable tableName="stock">
            <column autoIncrement="true" name="part_id" type="INTEGER">
                <constraints nullable="false" primaryKey="true" primaryKeyName="stock_pkey"/>
            </column>
            <column name="article_number" type="VARCHAR(100)"/>
            <column name="name" type="VARCHAR(255)"/>
            <column name="purchase_price" type="numeric(9, 2)"/>
            <column name="extra" type="INTEGER"/>
            <column name="price" type="numeric(9, 2)"/>
        </createTable>
    </changeSet>


    <changeSet author="Bisha" id="create_users_id_seq">
        <preConditions onFail="MARK_RAN">
            <not>
                <sequenceExists sequenceName="users_id_seq"/>
            </not>
        </preConditions>
        <comment>Create users_id_seq</comment>
        <createSequence cacheSize="1" cycle="false" dataType="bigint" incrementBy="1" maxValue="9223372036854775807"
                        minValue="1" sequenceName="users_id_seq" startValue="1"/>
    </changeSet>

    <changeSet author="Bisha" id="create_userstable">
        <preConditions onFail="MARK_RAN">
            <and>
                <not>
                    <tableExists tableName="userstable"/>
                </not>
                <not>
                    <tableExists tableName="users"/>
                </not>
            </and>
        </preConditions>
        <comment>Create userstable</comment>
        <createTable tableName="userstable">
            <column autoIncrement="true" name="id" type="INTEGER">
                <constraints nullable="false" primaryKey="true" primaryKeyName="userstable_pkey"/>
            </column>
            <column name="full_name" type="VARCHAR(355)"/>
            <column name="login" type="VARCHAR(100)"/>
            <column name="phone_number" type="VARCHAR(12)"/>
            <column name="procent" type="SMALLINT"/>
            <column name="access_level" type="INTEGER"/>
            <column name="status" type="BOOLEAN"/>
            <column name="password" type="VARCHAR(500)"/>
        </createTable>
    </changeSet>

    <changeSet author="Bisha" id="create_repair_parts_id_seq">
        <preConditions onFail="MARK_RAN">
            <not>
                <sequenceExists sequenceName="repair_parts_id_seq"/>
            </not>
        </preConditions>
        <comment>Create repair_parts_id</comment>
        <createSequence cacheSize="1" cycle="false" dataType="bigint" incrementBy="1" maxValue="9223372036854775807"
                        minValue="1" sequenceName="repair_parts_id_seq" startValue="1"/>
    </changeSet>

    <changeSet author="Bisha" id="create_parts">
        <preConditions onFail="MARK_RAN">
            <and>
                <not>
                    <tableExists tableName="parts"/>
                </not>
                <not>
                    <tableExists tableName="repair_parts"/>
                </not>
            </and>
        </preConditions>
        <comment>Create repair_parts</comment>
        <createTable tableName="parts">
            <column autoIncrement="true" name="part_id" type="INTEGER">
                <constraints nullable="false" primaryKey="true" primaryKeyName="repair_parts_pkey"/>
            </column>
            <column name="name" type="VARCHAR(355)"/>
            <column name="purchase_price" type="numeric(9, 2)"/>
            <column name="price" type="numeric(9, 2)"/>
            <column name="order_id" type="INTEGER"/>
            <column defaultValue="1" name="qty" type="INTEGER"/>
            <column name="stock_id" type="INTEGER"/>
            <column name="is_stock" type="BOOLEAN"/>
        </createTable>
    </changeSet>

    <changeSet author="Bisha" id="create_service_id_seq">
        <preConditions onFail="MARK_RAN">
            <not>
                <sequenceExists sequenceName="service_id_seq"/>
            </not>
        </preConditions>
        <comment>Create service_id_seq</comment>
        <createSequence cacheSize="1" cycle="false" dataType="bigint" incrementBy="1" maxValue="9223372036854775807"
                        minValue="1" sequenceName="service_id_seq" startValue="1"/>
    </changeSet>

    <changeSet author="Bisha" id="create_service_table">
        <preConditions onFail="MARK_RAN">
            <and>
                <not>
                    <tableExists tableName="service_table"/>
                </not>
                <not>
                    <tableExists tableName="works"/>
                </not>
            </and>
        </preConditions>
        <comment>Create works</comment>
        <createTable tableName="service_table">
            <column autoIncrement="true" name="service_id" type="INTEGER">
                <constraints nullable="false" primaryKey="true" primaryKeyName="service_id_pkey"/>
            </column>
            <column name="order_id" type="INTEGER"/>
            <column name="executor_id" type="INTEGER"/>
            <column name="description" type="VARCHAR(500)"/>
            <column name="price" type="numeric(9, 2)"/>
            <column defaultValueComputed="now()" name="time_stamp" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="executor_money" type="numeric(9, 2)"/>
            <column name="profit" type="numeric(9, 2)"/>
            <column defaultValue="1" name="quantity" type="INTEGER"/>
            <column name="is_custom" type="BOOLEAN"/>
            <column name="item_id" type="INTEGER"/>
        </createTable>
    </changeSet>

    <changeSet author="Bisha" id="create_FK_item_category">
        <preConditions onFail="MARK_RAN">
            <not>
                <foreignKeyConstraintExists foreignKeyName="FK_item_category"/>
            </not>
        </preConditions>
        <comment>Create FK_item_category</comment>
        <addForeignKeyConstraint baseColumnNames="category_id" baseTableName="item" constraintName="FK_item_category"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="category" validate="true"/>
    </changeSet>

    <changeSet author="Bisha" id="create_FK_orders_clients">
        <preConditions onFail="MARK_RAN">
            <not>
                <foreignKeyConstraintExists foreignKeyName="FK_orders_clients"/>
            </not>
        </preConditions>
        <comment>Create FK_orders_clients</comment>
        <addForeignKeyConstraint baseColumnNames="client_id" baseTableName="orderstable"
                                 constraintName="FK_orders_clients"
                                 deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="clientstable" validate="true"/>
    </changeSet>

    <changeSet author="Bisha" id="create_FK_orders_devices">
        <preConditions onFail="MARK_RAN">
            <not>
                <foreignKeyConstraintExists foreignKeyName="FK_orders_devices"/>
            </not>
        </preConditions>
        <comment>Create FK_orders_devices</comment>
        <addForeignKeyConstraint baseColumnNames="bike_id" baseTableName="orderstable"
                                 constraintName="FK_orders_devices"
                                 deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION"
                                 referencedColumnNames="device_id" referencedTableName="devicestable" validate="true"/>
    </changeSet>

    <changeSet author="Bisha" id="create_FK_orders_status">
        <preConditions onFail="MARK_RAN">
            <not>
                <foreignKeyConstraintExists foreignKeyName="FK_orders_status"/>
            </not>
        </preConditions>
        <comment>Create FK_orders_status</comment>
        <addForeignKeyConstraint baseColumnNames="execute_status" baseTableName="orderstable"
                                 constraintName="FK_orders_status" deferrable="false" initiallyDeferred="false"
                                 onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="statusid"
                                 referencedTableName="status" validate="true"/>
    </changeSet>

    <changeSet author="Bisha" id="create_FK_parts_orders">
        <preConditions onFail="MARK_RAN">
            <not>
                <foreignKeyConstraintExists foreignKeyName="FK_parts_orders"/>
            </not>
        </preConditions>
        <comment>Create FK_parts_orders</comment>
        <addForeignKeyConstraint baseColumnNames="order_id" baseTableName="parts"
                                 constraintName="FK_parts_orders" deferrable="false" initiallyDeferred="false"
                                 onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="order_id"
                                 referencedTableName="orderstable" validate="true"/>
    </changeSet>

    <changeSet author="Bisha" id="create_FK_parts_stock">
        <preConditions onFail="MARK_RAN">
            <not>
                <foreignKeyConstraintExists foreignKeyName="FK_parts_stock"/>
            </not>
        </preConditions>
        <comment>Create FK_parts_stock</comment>
        <addForeignKeyConstraint baseColumnNames="stock_id" baseTableName="parts"
                                 constraintName="FK_parts_stock" deferrable="false" initiallyDeferred="false"
                                 onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="part_id"
                                 referencedTableName="stock" validate="true"/>
    </changeSet>
</databaseChangeLog>
